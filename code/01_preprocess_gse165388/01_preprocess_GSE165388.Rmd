---
title: "GSE165388"
author: Yuji Okano
date: August 24, 2022
output:
  md_document:
    variant: markdown_github
---

# 01_preprocess

## Objectives
1. preprocessing GSE165388 data

### load data and make seurat object

```{r set-up}
library(dplyr)
library(Seurat)
library(patchwork)

raw.data <- Read10X(data.dir = "../../data/gse165388/GSM5032680_GW9/")
data <- CreateSeuratObject(counts = raw.data, project = "GSE165388_GW9", min.cells = 3, min.features = 200)
data
```
### check matrix
```{r, echo=FALSE}
raw.data[c("GAPDH", "NES", "DCX", "TUBB3", "GFAP"), 1:30]
```

### check difference between dense matrix and sparse matix
- dense matrix
```{r, echo=FALSE}
dense.size <- object.size(as.matrix(raw.data))
dense.size
```

## Export raw matrix
```{r}
if (! dir.exists("../../data/gse165388_count")) {
  dir.create("../../data/gse165388_count")
}

saveRDS(GetAssayData(data), file = "../../data/gse165388_count/gw9_raw.rds")
```

---
## QC
```{r}
data[["percent.mt"]] <- PercentageFeatureSet(data, pattern = "^MT-")
```

### visualization
```{r}
VlnPlot(data, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```

```{r, fig.dim=c(20, 6), out.width = "400px"}
plot1 <- FeatureScatter(data, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(data, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1
```

```{r}
plot2
```


```{r}
data <- subset(data, subset = nFeature_RNA > 200 & nFeature_RNA < 5000 & percent.mt < 20)
```

## Normalization
```{r}
data <- NormalizeData(data, normalization.method = "LogNormalize", scale.factor = 10000)
```

```{r}
dim(GetAssayData(data))
```


```{r}
saveRDS(GetAssayData(data), file = "../../data/gse165388_count/gw9_log.rds")
```


### visualization
```{r, fig.dim=c(20, 6), out.width = "400px"}
data <- FindVariableFeatures(data, selection.method = "vst", nfeatures = 2000)
# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(data), 10)
# plot variable features with and without labels
plot1 <- VariableFeaturePlot(data)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot2
```

## Data scaling (for PCA)
```{r}
all.genes <- rownames(data)
data <- ScaleData(data, features = all.genes)
```

## PCA
```{r, echo=FALSE}
data <- RunPCA(data, features = VariableFeatures(object = data))
```

### visualizaition
- loadings
```{r}
VizDimLoadings(data, dims = 1:2, reduction = "pca")
```

- scatter plot
```{r}
DimPlot(data, reduction = "pca")
```

- heat map
```{r}
DimHeatmap(data, dims = 1, cells = 500, balanced = TRUE)
```

```{r}
DimHeatmap(data, dims = 1:15, cells = 500, balanced = TRUE)
```

### determine n_dim
- Jack Straw plot
```{r}
data <- JackStraw(data, num.replicate = 100)
data <- ScoreJackStraw(data, dims = 1:20)
```

```{r}
JackStrawPlot(data, dims = 1:20)
```

- Elbow plot
```{r}
ElbowPlot(data)
```

- **Note**: when the data is small enough, `fa.parallel` from `psych` is useful

```{r}
dim(data)
```


## Clustering
```{r}
data <- FindNeighbors(data, dims = 1:50)
data <- FindClusters(data, resolution = 0.5)
```

## Embedding into Manifolds
### UMAP
```{r}
data <- RunUMAP(data, dims = 1:50)
DimPlot(data, reduction = "umap")
```

### tSNE
```{r}
data <- RunTSNE(data, dims = 1:100)
DimPlot(data, reduction = "tsne")
```

## Find DEG
- compare all clusters

```{r}
data.markers <- FindAllMarkers(data, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
data.markers %>%
    group_by(cluster) %>%
    slice_max(n = 2, order_by = avg_log2FC)
```

```{r}
if (! dir.exists("../../data/gse165388_deg")) {
  dir.create("../../data/gse165388_deg")
}

write.csv(data.markers, "../../data/gse165388_deg/gw9_deg.csv")
```


- heatmap
```{r, fig.dim=c(20, 20), out.width = "400px"}
data.markers %>%
    group_by(cluster) %>%
    top_n(n = 10, wt = avg_log2FC) -> top10
DoHeatmap(data, features = top10$gene) + NoLegend()
```

## Visualization

```{r}
VlnPlot(data, features = c(
  "NEUROD6", "SIX3", "DLX6-AS1",
  "SOX5", "SST", "TAC1"
  ))
```

```{r}
VlnPlot(data, features = c(
  "HIST1H4C", "CCND2", "VIM",
  "CENPF", "PTN", "EOMES"
  ))
```


```{r}
VlnPlot(data, features = c(
  "IGFBP7", "HBG2", "	PCP4", "SPP1"
  ))
```

- scatter plot
```{r}
FeaturePlot(data, features = c(
  "NEUROD6", "SIX3", "DLX6-AS1",
  "SOX5", "SST", "TAC1"
  ))
```

```{r}
FeaturePlot(data, features = c(
  "HIST1H4C", "CCND2", "VIM",
  "CENPF", "PTN", "EOMES"
  ))
```

```{r}
FeaturePlot(data, features = c(
  "IGFBP7", "HBG2", "	PCP4", "SPP1"
  ))
```

```{r}
if (! dir.exists("../../data/gse165388_cluster")) {
  dir.create("../../data/gse165388_cluster")
}

saveRDS(Idents(data), file = "../../data/gse165388_cluster/gw9.rds")
```

- After these procedure, clusters are **manually** annotated


new.cluster.ids <- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", "B", "CD8 T", "FCGR3A+ Mono",
    "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, new.cluster.ids)
DimPlot(pbmc, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()


### Expot all results

saveRDS(pbmc, file = "../../data/tutorial/pbmc_tutorial_all.rds")
